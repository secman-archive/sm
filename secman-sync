#!/bin/bash

SM_GH_UN=$(git config user.name)
create="gh repo create $SM_GH_UN/.secman -y --private"
brew_gh="brew install gh"
SECDIR=~/.secman
cd_SECDIR="cd $SECDIR"

# pkgs
ghraw_url="https://raw.githubusercontent.com"

install_brew="/bin/bash -c "$(curl -fsSL $ghraw_url/Homebrew/install/HEAD/install.sh)""

function usage() {
    local u=(
        "Flags:"
        "   -h | --help: help about any command"
        "Commands:"
        "   sy | sync: create private github repo and sync your passwords on it by git"
        "   cn | clone: clone .secman repo"
        "   ph | push: push and commit a new secret"
        "   pl | pull: pull secret/s"
    )

    printf "%s\n" "${u[@]}"
}

function repo_work() {
    local csi="cgit secman-i"
    local rdm="echo '# My secman passwords - $SM_GH_UN' >> $SECDIR/README.md"

    ${cd_SECDIR}

    ${rdm}

    ${create}

    ${csi}
}

UNAME=$(uname)

function repo() {
    if [ -x "$(command -v gh)" ]; then
        repo_work
    else
        if [[ "$UNAME" == Linux || "$UNAME" == Darwin ]]; then
            if [ -x "$(command -v brew)" ]; then
                ${brew_gh}

                if [ -x "$(command -v gh)" ]; then
                    repo_work
                fi
            else
                ${install_brew}

                if [ -x "$(command -v brew)" ]; then
                    ${brew_gh}

                    if [ -x "$(command -v gh)" ]; then
                        repo_work
                    fi
                fi
            fi
        elif [[ "$UNAME" == CYGWIN* || "$UNAME" == MINGW* ]]; then
            choco_gh="choco install gh"

            if [ -x "$(command -v choco)" ]; then
                ${choco_gh}

                if [ -x "$(command -v gh)" ]; then
                    repo_work
                fi
            else
                echo "you should install Chocolatey from this url https://chocolatey.org/install"
            fi
        fi
    fi
}

function corgit_ph() {
    local push="cgit ph"

    ${cd_SECDIR}
    ${push}
}

function corgit_pl() {
    ${cd_SECDIR}
    git pull
}

function clonex() {
    local clone="gh repo clone $SM_GH_UN/.secman $SECDIR"

    if [ -d $SECDIR ]; then
        rm -rf $SECDIR
        ${clone}
    else
        ${clone}
    fi
}

function badUsage() {
    local msg="$1"
    local txt=(
        "For an overview of the command, execute:"
        "secman-sync -h"
    )

    [[ $msg ]] && printf "$msg\n"

    printf "%s\n" "${txt[@]}"
}

bkp() {
    python3 ~/sm/backup.py $1
}

_phx() {
    ${cd_SECDIR}
    git add .
    git commit -m "new secman password"
    git push
}

version() {
    v="secman ver"

    if [ -x "$(command -v verx)" ]; then
        ${v}
    else
        curl -fsSL $ghraw_url/abdfnx/verx/HEAD/install.sh | bash

        if [ -x "$(command -v verx)" ]; then
            ${v}
        fi
    fi
}

while (($#)); do
    case "$1" in

    --help | -h)
        usage
        exit 0
        ;;

    --version | -v)
        version
        exit 0
        ;;

    sync | sy)
        repo
        exit 0
        ;;

    clone | cn)
        clonex
        exit 0
        ;;

    push | ph)
        corgit_ph
        exit 0
        ;;

    phx)
        _phx
        exit 0
        ;;

    pull | pl)
        corgit_pl
        exit 0
        ;;

    backup)
        bkp $2
        exit 0
        ;;
    *)
        badUsage "flag/command not recognized."
        exit 0
        ;;
    esac
done
